<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2013 Pykhov Gregory
  ~
  ~
  -->

<map:cfg
        xmlns:l="http://s1-platform.org/config/types/Long"
        xmlns:i="http://s1-platform.org/config/types/Integer"
        xmlns:f="http://s1-platform.org/config/types/Float"
        xmlns:d="http://s1-platform.org/config/types/Double"
        xmlns:bd="http://s1-platform.org/config/types/BigDecimal"
        xmlns:bi="http://s1-platform.org/config/types/BigInteger"
        xmlns:dt="http://s1-platform.org/config/types/Date"
        xmlns:b="http://s1-platform.org/config/types/Boolean"
        xmlns:map="http://s1-platform.org/config/types/Map"
        xmlns:list="http://s1-platform.org/config/types/List"

        collection="operations"
        class="org.s1.mongodb.table.MongoDBTable"
        >

    <map:schema>
        <list:attributes>
            <map:e name="src" label="Source account" type="ComplexType" appearance="required" typeClass="org.s1.table.JoinType">
                <map:typeCfg table="accounts"></map:typeCfg>
            </map:e>
            <map:e name="dest" label="Destination account" type="ComplexType" appearance="required" typeClass="org.s1.table.JoinType">
                <map:typeCfg table="accounts"></map:typeCfg>
                <validate><![CDATA[
                        if(parent.data.src.id == data.id)
                            return "Source and destination accounts are same";
                        ]]></validate>
            </map:e>
            <map:e name="sum" label="Sum" type="Double" appearance="required">
                <validate><![CDATA[
                        if(data<0)
                            return "Sum is less than 0";
                        ]]></validate>
            </map:e>
            <map:e name="date" label="Date" type="Date" appearance="required"></map:e>
        </list:attributes>
    </map:schema>

    <prepareSort><![CDATA[
            //prepare sort
            sort.name = "date";
            sort.desc = true;
            ]]></prepareSort>

    <list:actions>
        <map:e name="add" label="Add" to="present">
            <before><![CDATA[
                    data.date = s1.now();
                    ]]></before>
            <map:schema>
                <list:attributes>
                    <map:e name="src" label="Source account" type="ComplexType" appearance="required" typeClass="org.s1.table.JoinType">
                        <map:typeCfg table="accounts"></map:typeCfg>
                    </map:e>
                    <map:e name="dest" label="Destination account" type="ComplexType" appearance="required" typeClass="org.s1.table.JoinType">
                        <map:typeCfg table="accounts"></map:typeCfg>
                    </map:e>
                    <map:e name="sum" label="Sum" type="Double" appearance="required"></map:e>
                </list:attributes>
            </map:schema>
        </map:e>
    </list:actions>

    <list:states>
        <map:e name="present" label="Present"></map:e>
    </list:states>

    <list:indexes>
        <map:e b:unique="false">
            <list:fields>
                <e>date</e>
            </list:fields>
        </map:e>
        <map:e b:unique="false">
            <list:fields>
                <e>src.id</e>
            </list:fields>
        </map:e>
        <map:e b:unique="false">
            <list:fields>
                <e>dest.id</e>
            </list:fields>
        </map:e>
    </list:indexes>

</map:cfg>